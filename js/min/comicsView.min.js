(function(){var t,o,e=function(t,o){return function(){return t.apply(o,arguments)}},i=function(t,o){function e(){this.constructor=t}for(var i in o)r.call(o,i)&&(t[i]=o[i]);return e.prototype=o.prototype,t.prototype=new e,t.__super__=o.prototype,t},r={}.hasOwnProperty,s=[].slice;t=function(t){function o(t){this.parent=t,this.index=e(this.index,this),this.stripChange=e(this.stripChange,this),o.__super__.constructor.call(this)}return i(o,t),o.prototype.routes={"":"index","strip/:page(/)":"stripChange"},o.prototype.stripChange=function(t){return this.parent.setSlide(t)},o.prototype.index=function(){return this.parent.setSlide(1)},o}(Backbone.Router),o=function(o){function r(){var o;o=1<=arguments.length?s.call(arguments,0):[],this._done=e(this._done,this),this._error=e(this._error,this),this._show=e(this._show,this),this._hide=e(this._hide,this),this._loadEnd=e(this._loadEnd,this),this._loadStart=e(this._loadStart,this),this._selectSlide=e(this._selectSlide,this),this._next=e(this._next,this),this._prev=e(this._prev,this),this._unsetBookmark=e(this._unsetBookmark,this),this._setBookmark=e(this._setBookmark,this),this._toggleBookmark=e(this._toggleBookmark,this),this._keyBind=e(this._keyBind,this),this.showTooltip=e(this.showTooltip,this),this.removeBookmark=e(this.removeBookmark,this),this.addBookmark=e(this.addBookmark,this),this.setSlide=e(this.setSlide,this),this.events=e(this.events,this),this.initialize=e(this.initialize,this),this.selector=ui&&new ui.ComicsSelector("#comics-toolbar",'[data-plagin="select2"]'),this.loader=tools&&new tools.LoadingBox(".loading-box:eq(0)"),this.page=parseInt($("body").data("current_page")),this.lastPage=parseInt($("body").data("last_page")),this.name=$("body").data("comic_name"),this.id=$("body").data("comic_id"),this.base=$("body").data("base"),this.pushstate=$("body").data("pushstate")&&Modernizr&&Modernizr.history,this.bookmarkIcon=$("body").data("bookmark_icon"),this.route=new t(this),_.extend(this,o[0]),r.__super__.constructor.apply(this,o)}var n,a,h,p,u,l,c;return i(r,o),a="bookmark-adder",n="bookmark_adder-active",l=$('<div class="loading"></div>'),u=null,c=null,p=null,h=!0,r.prototype.selector=null,r.prototype.loader=null,r.prototype.route=null,r.prototype.parent=null,r.prototype.page=1,r.prototype.lastPage=0,r.prototype.$currentStrip=null,r.prototype.animateTime=200,r.prototype.name="",r.prototype.id=0,r.prototype.base="",r.prototype.pushstate=!1,r.prototype.bookmarkIcon=null,r.prototype.initialize=function(){var t;return u=this.$el.find(".comics_left-arrow"),c=this.$el.find(".comics_right-arrow"),this.$currentStrip=this.$el.find(".comics-box img"),this.selector.value(this.page),t=null!=main.bookmark?main.bookmark:tools.BookmarksView.getBookmarks({parent:this}),null!=t&&(t.collection.on("add",this._setBookmark),t.collection.on("remove",function(t){return function(o){return o.get("bookmark")===location.href?t._unsetBookmark():void 0}}(this)),t.find(location.href)&&this._setBookmark()),Backbone.history.start({pushState:this.pushstate,hashChange:!this.pushstate,root:this.base}),this.$el.find(".comics-box img").get(0).complete&&this.showTooltip(),$("."+a).bind({mouseenter:function(){return $(this).stop().animate({top:0},1e3)},mouseleave:function(){return $(this).stop().animate({top:-50},1e3)}})},r.prototype.events=function(){return $(this.selector).on("go",this._selectSlide),$(this.loader).on("start",this._loadStart),$(this.loader).on("end",this._loadEnd),this.$el.find(".comics-box img").on("load",this._loadEnd),$(window).keypress(this._keyBind),{"click .comics_left-arrow":"_prev","click .comics_right-arrow":"_next","click .bookmark-adder":"_toggleBookmark"}},r.prototype.setSlide=function(t){return t=parseInt(t),this.selector.value(this.page),$("#comics-current_page").text(this.page),this.page!==t?(this.page=parseInt(t),$.ajax({type:"GET",url:"/rest/comics/"+this.id+"/strip/"+t}).done(function(t){return function(o){return t._done(o.page,o.url)}}(this)).fail(function(t){return function(o){return t._error(o)}}(this))):void 0},r.prototype.addBookmark=function(){return null!=this.parent.bookmark?(this.parent.bookmark.add(this.bookmarkIcon,this.name+", страница: "+this.page,location.href),this._setBookmark()):void 0},r.prototype.removeBookmark=function(){return null!=this.parent.bookmark?(this.parent.bookmark.remove(location.href),this._unsetBookmark()):void 0},r.prototype.showTooltip=function(){return null!=this.parent&&null!=this.parent.tooltip&&h?(this.parent.tooltip.show(),h=!1):h&&window.tools?tools.TooltipsView.getTooltip().show():void 0},r.prototype._keyBind=function(t){return console.log(t.keyCode),37===t.keyCode&&this.page>1&&this._prev(),39===t.keyCode&&this.page<this.lastPage&&this._next(),$(window).off("keypress",this._keyBind),setTimeout(function(t){return function(){return $(window).keypress(t._keyBind)}}(this),400)},r.prototype._toggleBookmark=function(){return this.$el.find("."+a).hasClass(n)?this.removeBookmark():this.addBookmark()},r.prototype._setBookmark=function(){return this.$el.find("."+a).addClass(n)},r.prototype._unsetBookmark=function(){return this.$el.find("."+a).removeClass(n)},r.prototype._prev=function(){return this._hide(),$.ajax({type:"GET",url:"/strip/prev/"+this.page}).done(function(t){return function(o){return t.page=o.prev,t._done(o.prev,o.url)}}(this)).fail(function(t){return function(){return t._error}}(this))},r.prototype._next=function(){return this._hide(),$.ajax({type:"GET",url:"/strip/next/"+this.page}).done(function(t){return function(o){return t.page=o.next,t._done(o.next,o.url)}}(this)).fail(function(t){return function(o){return t._error(o)}}(this))},r.prototype._selectSlide=function(t,o){return this.setSlide(o)},r.prototype._loadStart=function(){return l.css({opacity:0}).animate({opacity:1},4*this.animateTime),this.$currentStrip.parents(".comics-box").append(l)},r.prototype._loadEnd=function(){return this.showTooltip(),l.remove(),this._show()},r.prototype._hide=function(){var t,o,e;return t=this.$currentStrip.parents(".comics-box"),e=t.width(),o=parseInt(t.height())+parseInt(t.css("padding-top"))+parseInt(t.css("padding-bottom")),t.css({width:e,height:o}),this.$currentStrip.animate({opacity:0},this.animateTime)},r.prototype._show=function(){var t,o;return t=this.$currentStrip.parents(".comics-box"),this.loader.setAlt(this.name+", strip "+this.page),o=this.loader.getImage(),null!=o?(o.css({opacity:0}),this.$currentStrip.replaceWith(o),t.css({width:"auto",height:"auto"}),o.animate({opacity:1},this.animateTime,function(t){return function(){return t.loader.reset()}}(this)),this.$currentStrip=o):void 0},r.prototype._error=function(t){return tools.TooltipsView.error("Ошибка загрузки",t.error)},r.prototype._done=function(t,o){var e;try{return this.setSlide(t),this.loader.setImage(o),u["fade"+(this.page>1&&this.lastPage>=this.page?"In":"Out")](this.animateTime),c["fade"+(this.page!==this.lastPage?"In":"Out")](this.animateTime),this.route.navigate("strip/"+this.page,{trigger:!0}),this.parent.bookmark.find(location.href)?this._setBookmark():this._unsetBookmark(),"undefined"!=typeof tools&&null!==tools&&null!=tools.TooltipsView&&tools.TooltipsView.errorClose(),!0}catch(i){return e=i,!1}},r.getComicsView=function(){var t;return t=1<=arguments.length?s.call(arguments,0):[],null==p?p=function(t,o,e){e.prototype=t.prototype;var i=new e,r=t.apply(i,o);return Object(r)===r?r:i}(this,t,function(){}):p},r}(Backbone.View),$(function(){return window.main.view=o.getComicsView({parent:window.main,el:".main-comic_page"})})}).call(this);