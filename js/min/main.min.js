(function(){var t,e,n,i,r,a,o,l,s,h,u=function(t,e){return function(){return t.apply(e,arguments)}},p=function(t,e){function n(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},c={}.hasOwnProperty,d=[].slice;t=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._setNumberOfRow=u(this._setNumberOfRow,this),this._reload=u(this._reload,this),this._create=u(this._create,this),this._update=u(this._update,this),this._remove=u(this._remove,this),this.search=u(this.search,this),this.render=u(this.render,this),e.__super__.constructor.apply(this,t)}return p(e,t),e.prototype.families=null,e.prototype.people=null,e.prototype.collection=null,e.prototype.modal=null,e.prototype.render=function(){return this.$el},e.prototype.search=function(t){var e,n,i,r,a,o,l,s,h;for(a=!1,h=this.searchAttr,l=0,s=h.length;s>l;l++)i=h[l],_.isObject(i)&&(1===_.keys(i).length?(n=this.$el.find("td").eq(_.values(i)[0]),e=n.find(".search-text"),n.find(".text-warning").each(function(){return $(this).replaceWith($(this).text())}),-1!==this.model.get(_.keys(i)[0]).toLowerCase().indexOf(t.toLowerCase())&&(e.html(e.html().replace(new RegExp("("+t+")","i"),"<span class='text-warning bg-primary'>$1</span>")),a=!0)):_.has(i,"eq")&&_.has(i,"key")&&(n=this.$el.find("td").eq(i.eq),e=n.find(".search-text"),r=this[_.first(_.keys(_.omit(i,["eq","key"])))],o=_.map(this.model.get(_.keys(i.key)[0]),function(){return function(t){return r.findWhere(_.object([_.values(i.key)[0]],[t]))}}(this)),n.find(".text-warning").each(function(){return $(this).replaceWith($(this).text())}),_.each(o,function(){return function(n){return null!=n&&-1!==n.get(_.first(_.values(_.omit(i,["eq","key"])))).toLowerCase().indexOf(t.toLowerCase())?(e.html(e.html().replace(new RegExp("("+t+")","i"),"<span class='text-warning bg-primary'>$1</span>")),a=!0):void 0}}(this))));return this.$el[a||!t?"show":"hide"]()},e.prototype._remove=function(){return bootbox.confirm("Вы уверены?",function(t){return function(e){return e?t.model.destroy():void 0}}(this))},e.prototype._update=function(){return this.trigger("edit",this.model)},e.prototype._create=function(){return $()},e.prototype._reload=function(){var t;return t=this._create(),$.when(this.$el.replaceWith(t)).then(function(e){return function(){return e.setElement(t),e.$el.trigger("setNumberOfRow")}}(this))},e.prototype._setNumberOfRow=function(){return this.$el.find("td").eq(0).text(this.$el.parents("table").find("tr").index(this.el))},e}(Backbone.View),e=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this.initialize=u(this.initialize,this),this.model=n,e.__super__.constructor.apply(this,t)}return p(e,t),e.prototype.localStorage=new Backbone.LocalStorage("Family"),e.prototype.model=null,e.prototype.initialize=function(){},e}(Backbone.Collection),n=function(t){function e(){return this.validate=u(this.validate,this),this.initialize=u(this.initialize,this),e.__super__.constructor.apply(this,arguments)}var n,i;return p(e,t),i=null,n=null,e.prototype.defaults={name:"",id:0},e.prototype.collection=null,e.prototype.people=null,e.prototype.localStorage=new Backbone.LocalStorage("Family"),e.prototype.initialize=function(){return n=$("#add_family-form")},e.prototype.validate=function(t){return _.isEmpty(t.name)?[n.find('input[name="name"]'),"Заполните поле имя"]:void 0},e}(Backbone.Model),i=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._showPersonElement=u(this._showPersonElement,this),this._showFamilyElement=u(this._showFamilyElement,this),this._lineTreePerson=u(this._lineTreePerson,this),this._lineTree=u(this._lineTree,this),this._center=u(this._center,this),this._endLine=u(this._endLine,this),this._line=u(this._line,this),this._rect=u(this._rect,this),this._text=u(this._text,this),this._person=u(this._person,this),this._family=u(this._family,this),this._draw=u(this._draw,this),this._clearSvg=u(this._clearSvg,this),this._createSvg=u(this._createSvg,this),this._close=u(this._close,this),this._open=u(this._open,this),this.open=u(this.open,this),this.events=u(this.events,this),this.initialize=u(this.initialize,this),_.extend(this,t[0]),e.__super__.constructor.apply(this,t)}var n,i,r,a,l,s;return p(e,t),r=null,s=null,l=[],a=[],n=[[]],i=[],e.prototype.people=null,e.prototype.families=null,e.prototype.parent=null,e.prototype.svg=null,e.prototype.params={width:870,height:300,padding:{top:8,right:8,bottom:8,left:8},margin:{left:8,right:10,top:20,bottom:8},family:{margin:{left:20,right:20}}},e.prototype.initialize=function(){return this.setElement($("#geneologic_tree-modal"))},e.prototype.events=function(){return{"show.bs.modal":"_open","hide.bs.modal":"_close"}},e.prototype.open=function(t){return r=t,this.$el.modal("show")},e.prototype._open=function(){return this._createSvg()},e.prototype._close=function(){return this._clearSvg(),r=null,s=null},e.prototype._createSvg=function(){return null===this.svg&&(this.svg=d3.select(this.$el.find(".modal-body").get(0)).append("svg"),this.svg.attr("width",this.params.width).attr("height",this.params.height).attr("class","tree"),this.svg.append("g").attr("class","lines")),s=this.people.tree(r),this._draw(s,null)},e.prototype._clearSvg=function(){return this.svg=null,this.$el.find(".modal-body").html("")},e.prototype._draw=function(t,e){var n,i,r;return i=this._family,r=this._person,n=this.svg.selectAll("svg.c"+new String(Math.random()*Math.pow(10,16)).slice(0,10)).data(t),n.enter().append("svg").attr("id",function(t){return t instanceof o?"person_"+t.get("id"):"family_"+t.husband.get("id")+"-"+t.wife.get("id")}).attr("class",function(t){return t instanceof o?"person":"family"}).attr("visibility","hidden").each(function(n,a){return n instanceof o?r(this,n,a,t,e):i(this,n,a,t,e)})},e.prototype._family=function(t,e,i,r,a){var o,l,s;return t=d3.select(t),o=_.map([e.husband,e.wife],function(e){return function(n,i){var r;return r=t.append("svg").attr("id",i?"wife-"+t.attr("id"):"husband-"+t.attr("id")).attr("class",i?"wife":"husband"),e._text(n.get("name"),r),r}}(this)),_.last(n).push(e),s=function(n){return function(l){var s,h,u;u=o[0].node();try{s=u.getBBox()}catch(p){h=p,s={x:u.clientLeft,y:u.clientTop,width:u.clientWidth,height:u.clientHeight}}return s.width>0&&s.height>0?(n._showFamilyElement(t,e,i,r,a,s),clearInterval(l)):void 0}}(this),l=setInterval(function(){return s(l)},10)},e.prototype._person=function(t,e,i,r,a){var o,l;return t=d3.select(t),this._text(e.get("name"),t),_.last(n).push(e),l=function(n){return function(o){var l,s,h;h=t.node();try{l=h.getBBox()}catch(u){s=u,l={x:h.clientLeft,y:h.clientTop,width:h.clientWidth,height:h.clientHeight}}return l.width>0&&l.height>0?(n._showPersonElement(t,e,i,r,a,l),clearInterval(o)):void 0}}(this),o=setInterval(function(){return l(o)},10)},e.prototype._text=function(t,e){return t=e.append("text").text(t)},e.prototype._rect=function(t){var e,n,i;return e=t.node().getBBox(),n=t.select("text"),i=n.node().getBBox(),t.insert("rect",":first-child").attr("width",e.width+this.params.padding.left+this.params.padding.right).attr("height",e.height+this.params.padding.top+this.params.padding.bottom).attr("ry","5").attr("rx","5"),n.attr("y",i.height+this.params.padding.top-i.y).attr("x",i.x+this.params.padding.left)},e.prototype._line=function(t,e){var n,i,r,a,o,l,s,h,u,p,c,d;return u=(parseInt($(t.node()).attr("x"))||0)+(parseInt($(t.node()).parents("svg").attr("x"))||0),p=(parseInt($(e.node()).attr("x"))||0)+(parseInt($(e.node()).parents("svg").attr("x"))||0),c=(parseInt($(t.node()).attr("y"))||0)+(parseInt($(t.node()).parents("svg").attr("y"))||0),d=(parseInt($(e.node()).attr("y"))||0)+(parseInt($(e.node()).parents("svg").attr("y"))||0),s=t.node().getBBox().width,h=e.node().getBBox().width,r=t.node().getBBox().height,a=e.node().getBBox().height,o=u+Math.floor(s/2),n=p+Math.floor(h/2),l=c+Math.floor(r/2),i=d+Math.floor(a/2),this.svg.select(".lines").append("path").attr("d","M "+o+" "+l+" L "+n+" "+i)},e.prototype._endLine=function(t){var e;return e=[],n.push([]),_.each(t,function(){return function(t){return _.each(t.children,function(t){return-1===e.indexOf(t)?e.push(t):void 0})}}(this)),e.length?this._draw(e,t):void 0},e.prototype._center=function(t){var e,n,r,a,o;return e=$(t.node()),o=parseInt(e.attr("x"))||0,a=t.node().getBBox().width,n=e.prevAll().andSelf().filter(function(){return $(this).attr("y")===e.attr("y")}),r=Math.floor(this.params.width/2)-Math.floor((o+a)/2),n.each(function(){return $(this).attr("x",r+parseInt($(this).attr("x")))}),n.each(function(t){return function(e,n){return"family"===$(n).attr("class")?t._line(d3.select($(n).find(".husband").get(0)),d3.select($(n).find(".wife").get(0))):void 0}}(this)),i.push(n)},e.prototype._lineTree=function(t,e){var n,i,r,a,o,l,s,h,u,p,c,d,f,m,g;return o=t.select(".husband"),h=t.select(".wife"),l=this.svg.select("#family_"+e.husband.get("parent").join("-")),s=this.svg.select("#family_"+e.wife.get("parent").join("-")),u=parseInt(t.attr("x"))||0,d=u+parseInt(h.attr("x")),f=parseInt(t.attr("y"))||0,r=[Math.floor(o.node().getBBox().width/2),Math.floor(o.node().getBBox().height/2)],a=[Math.floor(h.node().getBBox().width/2),Math.floor(h.node().getBBox().height/2)],l.size()&&(p=parseInt(l.attr("x"))||0,m=parseInt(l.attr("y"))||0,n=[parseInt($(l.select(".wife").node()).attr("x"))-Math.floor(this.params.family.margin.left/2),Math.floor(l.node().getBBox().height/2)],this.svg.select(".lines").append("path").attr("d","M "+(p+n[0])+" "+(m+n[1])+"\nl 0 25\nq0,3 "+(u+r[0]>p+n[0]?"3":"-3")+",3\nL "+(u+r[0]+(u+r[0]>p+n[0]?-3:3))+" "+(m+n[1]+28)+"\nq"+(u+r[0]>p+n[0]?"3":"-3")+",0 "+(u+r[0]>p+n[0]?"3":"-3")+",3\nL "+(u+r[0])+" "+(f+r[1]))),s.size()?(c=parseInt(s.attr("x"))||0,g=parseInt(s.attr("y"))||0,i=[parseInt($(s.select(".wife").node()).attr("x"))-Math.floor(this.params.family.margin.left/2),Math.floor(s.node().getBBox().height/2)],this.svg.select(".lines").append("path").attr("d","M "+(c+i[0])+" "+(g+i[1])+"\nl 0 25\nq0,3 "+(d+a[0]>c+i[0]?"3":"-3")+",3\nL "+(d+a[0]+3)+" "+(m+n[1]+28)+"\nq"+(d+a[0]>c+i[0]?"3":"-3")+",0 "+(d+a[0]>c+i[0]?"3":"-3")+",3\nL "+(d+a[0])+" "+(f+a[1]))):void 0},e.prototype._lineTreePerson=function(t,e){var n,i,r,a,o,l,s;return r=this.svg.select("#family_"+e.get("parent").join("-")),a=parseInt(t.attr("x"))||0,l=parseInt(t.attr("y"))||0,o=parseInt(r.attr("x"))||0,s=parseInt(r.attr("y"))||0,n=[Math.floor(t.node().getBBox().width/2),Math.floor(t.node().getBBox().height/2)],i=[parseInt($(r.select(".wife").node()).attr("x"))-Math.floor(this.params.family.margin.left/2),Math.floor(r.node().getBBox().height/2)],this.svg.select(".lines").append("path").attr("d","M "+(o+i[0])+" "+(s+i[1])+"\nl 0 25\nL "+(a+n[0])+" "+(l+n[1]))},e.prototype._showFamilyElement=function(t,e,r,a,o,l){var s,h,u,p,c,d;return d=0,h=t.select(".husband"),c=t.select(".wife"),null!=o&&(u=_.last(i),s=$(_.first(u)),d=(parseInt(s.attr("y"))||0)+s.get(0).getBBox().height+this.params.margin.top),_.each([h,c],function(t){return function(e){return e.select("text").attr("x",0).attr("y",e.select("text").node().getBBox().height),t._rect(e)}}(this)),c.attr("x",h.node().getBBox().width+this.params.family.margin.left),p=$(t.node()).prev("svg").filter(function(){return!_.contains(_.last(i),this)}),p.length?(l=p.get(0).getBBox(),t.attr("x",parseInt(p.attr("x"))+l.width+this.params.margin.left+this.params.margin.right)):t.attr("x",this.params.margin.left),t.attr("y",d),a.length===r+1&&(this._center(t),this._endLine(_.last(n))),a.length===r+1&&null!=o&&this._lineTree(t,e),$(t.node()).removeAttr("visibility")},e.prototype._showPersonElement=function(t,e,n,r,a,o){var l,s,h,u;return u=0,null!=a&&(s=_.last(i),l=$(_.first(s)),u=(parseInt(l.attr("y"))||0)+l.get(0).getBBox().height+this.params.margin.top),t.select("text").attr("x",0).attr("y",t.select("text").node().getBBox().height),this._rect(t),h=$(t.node()).prev("svg").filter(function(){return!_.contains(_.last(i),this)}),h.length?(o=h.get(0).getBBox(),t.attr("x",o.x+o.width+this.params.margin.left+this.params.margin.right)):t.attr("x",this.params.margin.left),t.attr("y",u),r.length===n+1&&this._center(t),r.length===n+1&&null!=a&&this._lineTreePerson(t,e),$(t.node()).removeAttr("visibility")},e}(Backbone.View),r=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._createTree=u(this._createTree,this),this._create=u(this._create,this),this.events=u(this.events,this),this.initialize=u(this.initialize,this),n=_.template($("#family-teplete").html()),this.modal=$("#add_family-modal"),_.extend(this,t[0]),this.collection=this.families,e.__super__.constructor.apply(this,t)}var n;return p(e,t),n=null,e.prototype.modal=null,e.prototype.searchAttr=[{name:1}],e.prototype.initialize=function(){return this.setElement(this._create())},e.prototype.events=function(){return this.model.on("destroy",function(t){return function(){return t.$el.remove()}}(this)),this.model.on("change",this._reload),{"click .fa-remove":"_remove","click .fa-pencil":"_update","click .fa-group":"_createTree",setNumberOfRow:"_setNumberOfRow"}},e.prototype._create=function(){return $(n({num:0,name:this.model.get("name")}))},e.prototype._createTree=function(){return this.trigger("tree",this.model)},e}(t),a=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._sort=u(this._sort,this),this._findRelationFamily=u(this._findRelationFamily,this),this._findChildren=u(this._findChildren,this),this._createFamily=u(this._createFamily,this),this.tree=u(this.tree,this),this.model=o,e.__super__.constructor.apply(this,t)}var n,i;return p(e,t),n=[],i={},e.prototype.localStorage=new Backbone.LocalStorage("People"),e.prototype.model=null,e.prototype.tree=function(t){var r,a,l;return n=[],i={},r=t.get("id"),a=new e(this.models.filter(function(){return function(t){return-1!==t.get("family").indexOf(r)}}(this))),l=new e(a.filter(function(){return function(t){return _.isEmpty(t.get("parent"))}}(this))),l.each(function(e){return function(i){if(t=e._createFamily(a,i),!_.contains(n,t)){if(t instanceof o)return n.push(t);if(_.isEmpty(t.husband.get("parent"))&&_.isEmpty(t.wife.get("parent")))return n.push(t)}}}(this)),_.each(n,function(t){return function(e){var i;return e instanceof o||(i=t._findRelationFamily(t,e),null==i)?void 0:n=n.concat(i)}}(this)),n.sort(this._sort),n},e.prototype._createFamily=function(t,e){var n,r;return n={},r=t.findWhere({relation:e.get("id")}),r?(_.each([r,e],function(){return function(t){return t.isMale()&&_.extend(n,{husband:t}),t.isFemale()?_.extend(n,{wife:t}):void 0}}(this)),null==i[n.husband.get("id")+"-"+n.wife.get("id")]?(_.extend(n,{children:this._findChildren(t,n.husband,n.wife)}),i[n.husband.get("id")+"-"+n.wife.get("id")]=n):i[n.husband.get("id")+"-"+n.wife.get("id")]):e},e.prototype._findChildren=function(t,e,n){var i,r,a,l;return a=e.get("id"),l=n.get("id"),r=[],i=t.filter(function(){return function(t){var e;return e=t.get("parent"),_.isEmpty(_.difference(e,[a,l]))&&!_.isEmpty(e)}}(this)),_.each(i,function(t){return function(e){var n;return n=t._createFamily(t,e),_.contains(r,n)?void 0:r.push(n)}}(this)),_.each(r,function(t){return function(e){var n;return e instanceof o||(n=t._findRelationFamily(t,e),null==n)?void 0:r=r.concat(n)}}(this)),r.sort(this._sort),r},e.prototype._findRelationFamily=function(t,e){var n;return e.children.length?(n=[],_.each(e.children,function(t){return function(i){var r;return r=null,i instanceof o||_.each([i.husband,i.wife],function(t){var n;return n=t.get("parent"),_.isEmpty(_.difference([e.wife.get("id"),e.husband.get("id")],n))||_.isEmpty(n)?void 0:r=t}),null!=r?n.push(t._createFamily(t,t.findWhere({id:r.get("parent")[0]}))):void 0}}(this)),n):void 0},e.prototype._sort=function(t,e){var n,i,r,a,l;return r=!(t instanceof o||e instanceof o),n=r&&null!=t.children&&null!=e.children&&null!=t.children[0]&&null!=e.children[0],i=!(!n||t.children[0]instanceof o||e.children[0]instanceof o),l=i&&t.children[0]===e.children[0],a=l&&-1!==t.children[0].husband.get("parent").indexOf(t.husband.get("id")),a?i?0:-1:1},e}(Backbone.Collection),o=function(t){function e(){return this.validate=u(this.validate,this),this.getOneLetter=u(this.getOneLetter,this),this.isFemale=u(this.isFemale,this),this.isMale=u(this.isMale,this),this.initialize=u(this.initialize,this),e.__super__.constructor.apply(this,arguments)}var n;return p(e,t),n=null,e.prototype.defaults={parent:[],relation:null,family:[],gender:null,name:"",id:0},e.prototype.view=null,e.prototype.localStorage=new Backbone.LocalStorage("People"),e.prototype.initialize=function(){return n=$("#add_human-form")},e.prototype.isMale=function(){return"male"===this.get("gender")},e.prototype.isFemale=function(){return"female"===this.get("gender")},e.prototype.getOneLetter=function(){var t;return this.isMale()&&(t="M"),this.isFemale()&&(t="Ж"),t},e.prototype.validate=function(t){return this.set("family",this.get("family").map(function(t){return parseInt(t)})),_.isEmpty(t.name)?[n.find('input[name="name"]'),"Заполните поле имя"]:"none"===t.gender?[n.find('select[name="gender"]'),"Выберите пол"]:t.family.length>2?[n.find('select[name="family"]'),"Не больше двух семей"]:void 0},e}(Backbone.Model),l=function(t){function e(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._editRelation=u(this._editRelation,this),this._create=u(this._create,this),this.events=u(this.events,this),this.initialize=u(this.initialize,this),n=_.template($("#people-templete").html()),this.modal=$("#add_human-modal"),_.extend(this,t[0]),this.collection=this.people,e.__super__.constructor.apply(this,t)}var n;return p(e,t),n=null,e.prototype.searchAttr=[{name:1},{families:"name",eq:3,key:{family:"id"}}],e.prototype.initialize=function(){return this.setElement(this._create())},e.prototype.events=function(){return this.model.on("destroy",function(t){return function(){return t.$el.remove()}}(this)),this.model.on("change",this._reload),{"click .fa-remove":"_remove","click .fa-pencil":"_update","click .fa-group":"_editRelation",setNumberOfRow:"_setNumberOfRow"}},e.prototype._create=function(){var t,e,i;try{_.isArray(this.model.get("family"))&&(i=function(){var t,e,n,r;for(n=this.model.get("family"),r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(this.families.findWhere({id:parseInt(i)}).get("name"));return r}.call(this).join(", "))}catch(r){e=r,i=null}return t=$(n({num:0,name:this.model.get("name"),gender:this.model.getOneLetter(),family:i||"Нет семьи"})),this.model.isMale()&&t.find("td").eq(2).html('<span class="fa fa-male"></span>'),this.model.isFemale()&&t.find("td").eq(2).html('<span class="fa fa-female"></span>'),t},e.prototype._editRelation=function(){return this.trigger("relation",this.model)},e}(t),s=function(){function t(){this.initialize=u(this.initialize,this),this.initialize()}var e;return e=null,t.prototype.view=null,t.prototype.initialize=function(){return _.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{(.+?)\}\}/g,escape:/\{\{\{([\s\S]+?)\}\}\}/g},bootbox.addLocale("ru",{OK:"Применить",CANCEL:"Отмена",CONFIRM:"Подтвердить"}),bootbox.setDefaults("locale","ru")},t.getSiteController=function(){return null===e?e=new t:void 0},t}(),$(function(){return window.main=s.getSiteController()}),h=function(t){function s(){var t;t=1<=arguments.length?d.call(arguments,0):[],this._validate=u(this._validate,this),this._clearForm=u(this._clearForm,this),this._relationFactory=u(this._relationFactory,this),this._editFamily=u(this._editFamily,this),this._edit=u(this._edit,this),this._familyModalOpen=u(this._familyModalOpen,this),this._humanModalOpen=u(this._humanModalOpen,this),this._loadFamilyInSelect=u(this._loadFamilyInSelect,this),this._search=u(this._search,this),this._saveFamily=u(this._saveFamily,this),this._saveHuman=u(this._saveHuman,this),this._clearStorage=u(this._clearStorage,this),this.renderTable=u(this.renderTable,this),this.render=u(this.render,this),this.createTestCollections=u(this.createTestCollections,this),this.events=u(this.events,this),this.initialize=u(this.initialize,this),_.extend(this,t[0]),this.people=new a,this.families=new e,this.people.fetch(),this.families.fetch(),m=_.template($("#relation-template").html()),s.__super__.constructor.apply(this,t)}var h,c,f,m;return p(s,t),c=null,h=!0,f=null,m=null,s.prototype.parent=null,s.prototype.people=null,s.prototype.families=null,s.prototype.tree=null,s.prototype.initialize=function(){return this.people.isEmpty()&&this.families.isEmpty()&&this.createTestCollections(),this.tree=new i({parent:this,people:this.people,families:this.families}),this.render()},s.prototype.events=function(){return this.people.on("add",function(t){return function(e){return t.renderTable($("#people"),t.people,function(){var t;return t=1<=arguments.length?d.call(arguments,0):[],function(t,e,n){n.prototype=t.prototype;var i=new n,r=t.apply(i,e);return Object(r)===r?r:i}(l,t,function(){})},e)}}(this)),this.families.on("add",function(t){return function(e){return t.renderTable($("#families"),t.families,function(){var t;return t=1<=arguments.length?d.call(arguments,0):[],function(t,e,n){n.prototype=t.prototype;var i=new n,r=t.apply(i,e);return Object(r)===r?r:i}(r,t,function(){})},e)}}(this)),this.families.on("change",function(t){return function(e){return t._loadFamilyInSelect(),t.people.each(function(t){return-1!==t.get("family").indexOf(e.get("id"))?t.trigger("change"):void 0})}}(this)),{"keyup #search":"_search","submit #add_human-form":"_saveHuman","submit #add_family-form":"_saveFamily","shown.bs.modal #add_human-modal":"_humanModalOpen","shown.bs.modal #add_family-modal":"_familyModalOpen","click #clear_storage":"_clearStorage"}},s.prototype.createTestCollections=function(){return this.families.create({name:"Пупкины",id:1}),this.families.create({name:"Ивановы",id:2}),this.families.create({name:"Егоровы",id:3}),this.people.create({name:"Александр Пупкин",gender:"male",family:[1],relation:2,id:1}),this.people.create({name:"Татьяна Пупкина",gender:"female",family:[1],relation:1,id:2}),this.people.create({name:"Сергей Иванов",gender:"male",family:[2],relation:4,id:3}),this.people.create({name:"Валентина Иванова",gender:"female",family:[2],relation:3,id:4}),this.people.create({name:"Василий Александрович Пупкин",gender:"male",family:[1],relation:6,parent:[1,2],id:5}),this.people.create({name:"Анастасия Сергеевна Иванова",gender:"female",family:[1,2],relation:5,parent:[3,4],id:6}),this.people.create({name:"Ирина Васильевна Пупкина",gender:"female",family:[1,2],parent:[5,6],id:7}),this.people.create({name:"Антон Егоров",gender:"male",family:[3],relation:9,id:8}),this.people.create({name:"Марина Егорова",gender:"female",family:[3],relation:8,id:9})},s.prototype.render=function(){return this.renderTable($("#people"),this.people,function(){return function(){var t;return t=1<=arguments.length?d.call(arguments,0):[],function(t,e,n){n.prototype=t.prototype;var i=new n,r=t.apply(i,e);return Object(r)===r?r:i}(l,t,function(){})}}(this)),this.renderTable($("#families"),this.families,function(){return function(){var t;return t=1<=arguments.length?d.call(arguments,0):[],function(t,e,n){n.prototype=t.prototype;var i=new n,r=t.apply(i,e);return Object(r)===r?r:i}(r,t,function(){})}}(this)),$('[data-toggle="tooltip"]').tooltip(),$('[data-toggle="select2"]').select2(),this._loadFamilyInSelect()},s.prototype.renderTable=function(t,e,n,i){return e.length&&null==i?(t.removeClass("hide"),e.each(function(i){return function(r){return i.renderTable(t,e,n,r)}}(this))):null!=i?(i.view=n({model:i,people:this.people,families:this.families}),i.view.on("edit",this._edit).on("tree",this.tree.open).on("relation",this._editFamily).render().appendTo(t.find("tbody")).trigger("setNumberOfRow")):void 0},s.prototype._clearStorage=function(){return localStorage.clear(),this.createTestCollections(),location.href=location.href},s.prototype._saveHuman=function(t){var e,n;return e=$(t.currentTarget),n=f||new o(_.extend({id:this.people.max("id").get("id")+1},e.serializeObject())),null!=f&&n.set(e.serializeObject()),n.on("invalid",this._validate),this._clearForm(e),n.isValid()?(null==f?this.people.create(n):(f.save(),f=null),$("#add_human-modal").modal("hide")):void 0},s.prototype._saveFamily=function(t){var e,i;return e=$(t.currentTarget),i=f||new n(_.extend({id:this.families.max("id").get("id")+1},e.serializeObject())),null!=f&&i.set(e.serializeObject()),i.on("invalid",this._validate),this._clearForm(e),i.isValid()?(null==f?this.families.create(i):(f.save(),f=null),$("#add_family-modal").modal("hide")):void 0},s.prototype._search=function(t){var e;return e=$(t.currentTarget),this.people.each(function(){return function(t){return t.view.search(e.val())}}(this)),this.families.each(function(){return function(t){return t.view.search(e.val())}}(this))},s.prototype._loadFamilyInSelect=function(){var t;return t=$("#add_human_family-select"),t.find("option").remove(),t.select2({data:this.families.map(function(){return function(t){return{id:t.get("id"),text:t.get("name")}}}(this)),placeholder:"Выбери семью",maximumSelectionLength:2})},s.prototype._humanModalOpen=function(t){var e;return h&&(e=$(t.currentTarget),e.find("input").val(""),this._clearForm($("#add_human-form")),$("#add_human_gender-input").val("none").trigger("change"),$("#add_human_family-select").val("").trigger("change"),f=null),h=!0},s.prototype._familyModalOpen=function(t){var e;return h&&(e=$(t.currentTarget),e.find("input").val(""),f=null),h=!0},s.prototype._edit=function(t){var e,n,i,r,a,o;h=!1,f=t,n=t.view.modal,e=n.find("form"),n.modal("show"),a=t.toJSON(),o=[];for(i in a)r=a[i],o.push(e.find("[name='"+i+"'], [name='"+i+"[]']").val(r).trigger("change"));return o},s.prototype._editFamily=function(t){var e,n;return n=this.people.filter(function(e){return _.intersection([t.get("id")],e.get("parent")).length}),e=$("#geneologic_editor-modal").find("table tbody"),$("#geneologic_editor-man").html(t.get("name")),$("#geneologic_editor-modal").find("table tbody td").filter(function(){return function(t){return t>0}}(this)).remove(),$("#geneologic_editor-modal").modal("show"),$("#add_relation").off().click(function(n){return function(){return e.append(n._relationFactory({related:!1,child_for:!1,parent:!1},t))}}(this)),null!=t.get("relation")&&e.append(this._relationFactory({related:!0,child_for:!1,parent:!1},t)),_.each(t.get("parent"),function(n){return function(i){return t.get("parent").length?e.append(n._relationFactory({related:!1,child_for:!0,parent:!1},t,i)):void 0}}(this)),_.each(n,function(i){return function(r){return n.length?e.append(i._relationFactory({related:!1,child_for:!1,parent:!0},t,r.get("id"))):void 0}}(this)),e.append(this._relationFactory({related:!1,child_for:!1,parent:!1},t))},s.prototype._relationFactory=function(t,e,n){var i,r,o,l;return r=$(m(_.extend(t,{man:e.get("name")}))),o=function(t){return function(){var i,o,l,s;switch(s=e.get("id"),l=null,o=r.find('[data-toggle="select2"]').eq(0),i=r.find('[data-toggle="select2"]').eq(1),i.find("option").filter(function(t){return t>0}).remove(),o.val()){case"related":e.isFemale()&&(l=new a(t.people.filter(function(t){return t.isMale()}))),e.isMale()&&(l=new a(t.people.filter(function(t){return t.isFemale()})));break;case"child_for":l=new a(t.people.filter(function(t){return!_.isEmpty(e.get("family"))&&null!=t.get("relation")&&_.intersection(t.get("family"),e.get("family")).length&&-1===[s,parseInt(e.get("relation"))].indexOf(t.get("id"))}));break;case"parent":l=new a(t.people.filter(function(t){return null!=n&&t.get("id")===n?!0:!_.isEmpty(e.get("family")&&_.isEmpty(t.get("parent"))&&_.intersection(t.get("family"),e.get("family")).length&&null!=e.get("relation")&&-1===[s,parseInt(e.get("relation"))].indexOf(t.get("id")))}))}return null!=l?i.select2({data:l.map(function(t){return{id:t.get("id"),text:t.get("name")}})}):void 0}}(this),l=function(t){return function(n,i){var a,o,l,s,h;if(o=r.find('[data-toggle="select2"]').eq(0),a=r.find('[data-toggle="select2"]').eq(1),"none"===a.val()){switch(o.val()){case"related":e.set("relation",null),e.save();break;case"child_for":e.set("parent",[]),e.save();break;case"parent":l=t.people.findWhere({id:i}),l.set("parent",[]),l.save()}return r.remove()}switch(o.val()){case"related":return s=h=t.people.findWhere({id:parseInt(a.val())}),e.set("relation",parseInt(a.val())),s.set("relation",e.get("id")),e.save();case"child_for":if(h=t.people.findWhere({id:parseInt(a.val())}),null!=h.get("relation"))return e.set("parent",[h.get("id"),h.get("relation")]),e.save();break;case"parent":if(l=t.people.findWhere({id:parseInt(a.val())}),null!=e.get("relation"))return l.set("parent",[e.get("id"),e.get("relation")]),l.save()}}}(this),r.find('[data-toggle="select2"]').select2().eq(0).on("select2:select",o).end().eq(1).on("select2:select",function(t){return l(t,n)}),(t.related||t.child_for||t.parent)&&(o(),i=r.find('[data-toggle="select2"]').eq(1),(t.parent||t.child_for)&&null!=n&&i.val(n).trigger("change"),t.related&&i.val(this.people.findWhere({id:e.get("relation")}).get("id")).trigger("change")),r},s.prototype._clearForm=function(t){return null!=t&&t.length?t.find(".has-error").removeClass("has-error").end().find('.text-danger, input[name="id"]').remove():void 0},s.prototype._validate=function(t,e){var n,i;return i=e[0],n=e[1],i.parents(".form-group").addClass("has-error").append("<div class='text-danger'>"+n+"</div>")},s.getSiteView=function(){var t;return t=1<=arguments.length?d.call(arguments,0):[],null===c?c=function(t,e,n){n.prototype=t.prototype;var i=new n,r=t.apply(i,e);return Object(r)===r?r:i}(s,t,function(){}):c},s}(Backbone.View),$(function(){return main.view=h.getSiteView({parent:main,el:".main"})})}).call(this);